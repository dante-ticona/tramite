INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC1', 'MENOS DE 120 APORTES CON CCM', 1, 'Por medio de la presente, tenemos a bien poner a su conocimiento que luego de procesar la Solicitud de Pensión del Asegurado de referencia, la misma fue rechazada debido a que se identificó que no cumple los requisitos necesarios para acceder a una Prestación de Vejez, toda vez que el Saldo Acumulado en su Cuenta Personal Previsional, más su Compensación de Cotizaciones Mensual (CCM), no le permite financiar una Pensión de por lo menos el 60% de su Referente Salarial de Vejez, tal y como lo establece el Art. 8 inciso b) de la Ley N° 065/2010. De igual forma efectuado el análisis de su caso, no accede a una Pension Solidaria de Vejez ya que no cuenta con los 120 aportes requeridos en el Art. 13 inc. b) de la mencionada Ley. Finalmente, hago de su conocimiento que en cumplimiento a lo establecido en el Art. 172 inc. a) del DS. 0822- 2011 modificado por el D.S. 1888-2014, el Asegurado puede acceder al Beneficio de Retiros Mínimos o Retiro Final y pago de la CC Mensual, en virtud al Art. 47 Parágrafo II de la R.A. 032-2011.', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');
INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC2', 'MENOS DE 120 APORTES SIN CCM', 2, 'Por medio de la presente, tenemos a bien poner a su conocimiento que luego de procesar la Solicitud de Pensión del Asegurado de referencia, la misma fue rechazada debido a que se identificó que no cumple los requisitos necesarios para acceder a una Prestación de Vejez, toda vez que el Saldo Acumulado en su Cuenta Personal Previsional, no le permite financiar una Pensión de por lo a el 60% de su Referente Salarial de Vejez, tal y como lo establece el Art. 8 inciso a) de la Ley N°65/2010. De igual forma efectuado el análisis de su caso, no accede a la Prestación Solidaria de Vejez por que no cuenta con los 120 aportes requeridos en el Art. 13 inc. b) de la mencionada Ley. Finalmente, hago de su conocimiento que en cumplimiento a lo establecido en el Art. 172 inc. a) del DS. 822, modificada por el D.S. 1888, el Asegurado puede acceder al Beneficio de Retiros Mínimos o Retiro Final.', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');
INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC3', 'MENOS DE 120 APORTES Y CON CCG', 3, 'Por medio de la presente, tenemos a bien poner a su conocimiento que luego de procesar la Solicitud de Pensión del Asegurado de referencia, la misma fue rechazada debido a que  no cumple los requisitos necesarios para acceder a una Prestación de  Vejez, toda vez que su Saldo Acumulado en su Cuenta Personal Previsional, no le permite financiar una Pensión de por lo menos el 60% de un Referente Salarial de Vejez, tal y como lo establece el Art. 8 inciso b) de la Ley N°65/2010. De igual forma efectuado el análisis de su caso, no accede a la Prestación Solidaria de Vejez por que no cuenta con los 120 aportes requeridos en el Art. 13 inc. b) de la mencionada Ley. Finalmente, hago de su conocimiento que en cumplimiento a lo establecido en el Art. 172 inc. a) del DS. 822, modificada por el DS.1888, el Asegurado puede acceder al Beneficio de Retiros Mínimos o Retiro Final.', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');
INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC4', 'CON RETIROS MINIMO Y MAS DE 120 APORTES CON CCM', 4, 'Por medio de la presente, tenemos a bien poner a su conocimiento que luego de procesar la Solicitud de Pensión del Asegurado de referencia, la misma fue rechazada debido a que no cumple los requisitos necesarios para acceder a una Prestación de Vejez, toda vez que su Saldo Acumulado en su Cuenta Personal Previsional, no le permite financiar una Pensión de por lo menos el 60% de su Referente Salarial de Vejez, tal y como lo establece el Art. 8 inciso a) de la Ley N°65/2010. De igual forma efectuado el análisis de su caso, no accede a la Prestación Solidaria de Vejez de acuerdo al Art. 22 de la Ley 065/2010 debido a que posee Retiros Mínimos no repuestos.  Finalmente, hago de su conocimiento que en cumplimiento a lo establecido en el Art. 172 inc. a) del DS. 0822- 2011 modificado por el D.S. 1888-2014, el Asegurado puede acceder al Beneficio de Retiros Mínimos o Retiro Final y pago de CCMensual, en virtud al Art. 47 Parágrafo II de la R.A. 032-2011.', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');
INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC5', 'DEVOLUCION DE APORTES 1392 SIN CC', 5, 'Por medio de la presente, tenemos a bien poner a su conocimiento que luego de procesar la Solicitud de Pensión del Asegurado de referencia, la misma fue rechazada debido a que  no cumple los requisitos necesarios para acceder a una Prestación de Vejez, toda vez que el Saldo Acumulado en su Cuenta Personal Previsional, no le permite financiar un monto de Pensión mayor o igual al 60% de su referente Salarial de vejez, tal y como lo establece el Art. 8 inc. a) de la Ley de Pensiones N° 65/2010. Finalmente, hago de su conocimiento que en cumplimiento a lo establecido en el Art. 172 inc. a) del DS. 822-2011 modificado por el D.S. 1888-2014, el Asegurado puede acceder al Beneficio de Retiros Mínimos o Retiro Final.', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');
INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC6', 'DEVOLUCION DE APORTES 1392 SIN CC Y MENOR DE 58 AÑOS', 6, 'Por medio de la presente, tenemos a bien poner a su conocimiento que luego de procesar la Solicitud de Pensión del Asegurado de referencia, la misma fue rechazada debido a que no cumple los requisitos necesarios para acceder a una Prestación de Vejez, toda vez que el Saldo Acumulado en su Cuenta Personal Previsional, no le permite financiar un monto de Pensión mayor o igual al 60% de su referente Salarial de vejez, tal y como lo establece el Art. 8 inc. a) de la Ley de Pensiones N° 65/2010. De igual forma efectuado el análisis de su caso, no accede a la Prestación Solidaria de Vejez  ya que no cumple con el Mínimo de edad requerido en el Art. 13 inc. a) de la mencionada Ley.', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');
INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC7', 'RECHAZO CON RETIROS EFECTUADOS CON ANTERIORIDAD Y SIN REFERENTE SALARIAL Y SIN CCM', 7, 'Por medio de la presente, tenemos a bien poner a su conocimiento que luego de procesar la Solicitud de Pensión del Asegurado de referencia, la misma fue rechazada debido a que no cumple los requisitos necesarios para acceder a una Prestación de Vejez, toda vez que su Saldo Acumulado en su Cuenta Personal Previsional, no contará con 120 aportes requeridos según el Art. 8 inc. c) de la ley 065/2010. De igual forma efectuado el análisis de su caso, no accede a la Prestación Solidaria de Vejez ya que según el Art. 22 de la Ley 065/2010 posee Retiros Mínimos no repuestos y aún con dicha reposición no contará con los 120 aportes requeridos en el Art. 13 inc. b) de la mencionada Ley. Finalmente, hago de su conocimiento que en cumplimiento a lo establecido en el Art. 172 a) del DS. 822 modificado por el D.S. 1888/2014, el Asegurado puede acceder al Beneficio de Retiros Mínimos o Retiro Final.', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');
INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC8', 'ASEGURADOS QUE CUENTEN CON DEVOLUCION DE APORTES Y SOLO ACCEDEN AL CALCULO DE LA PENSION DE VEJEZ', 8, 'Mediante la presente en consideración a que ha accedido a la devolución parcial o total de sus aportes en el marco de la Ley N° 1392, el Decreto Supremo N° 4582 y la Resoluciónn Administrativa APS/DJ/DP/N° 954/2021 de la Autoridad de Pensiones y Seguros -APS-, informamos: Que para verificar el acceso a una Pensión Solidaria de Vejez, o sus Derechohabientes a una Pensión por Muerte derivada de Solidaria de Vejez deberá reponer el monto retirado más los rendimientos que se hubieran generado, previo al inicio de su trámite de solicitud de Pensión en la AFP. De no efectuarse la reposición de los recursos, una vez firmado la solicitud perderá¡ el derecho a una Pensión Solidaria de Vejez, verificÃ¡ndose el acceso solo a la Pensión de Vejez conforme lo dispone la Ley N° 1392, la Ley N° 065 y sus normativas reglamentarias.', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');
INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC9', 'RECHAZO MENOS DE 120 APORTES Y MENOR DE 58 AÑOS', 9, 'Por medio de la presente, tenemos a bien poner a su conocimiento que luego de procesar la Solicitud de Pensión del Asegurado de referencia, la misma fue rechazada  debido a que no cumple los requisitos necesarios para acceder a una Prestación de Vejez, toda vez que el Saldo Acumulado en su Cuenta Personal Previsional, no le permite financiar un monto de Pensión mayor o igual al 60% de su referente Salarial de vejez, tal y como lo establece el Art. 8 inc. a) de la ley 065/2010. Igualmente, no accede a la Prestación Solidaria de Vejez por que no cuenta con los 120 aportes requeridos en el Art. 13 inc. b) de la mencionada Ley. De igual forma no accede a una Pensión Solidaria de Vejez ya que no cumple con el Mínimo de edad requerido en el Art. 13 inc. a) de la mencionada Ley.', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');
INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC10', 'RECHAZO CON RETIROS EFECTUADOS CON ANTERIORIDAD Y SIN REFERENTE SALARIAL Y SIN CCM', 10, 'Por medio de la presente, hago de su conocimiento que luego de procesar la Solicitud de Pensión de referencia, la misma ha sido rechazada debido a que no cumple los requisitos necesarios para acceder a una Prestación de Vejez, toda vez que su Saldo Acumulado en su Cuenta Personal Previsional, no contará con 120 aportes requeridos según el Art. 8 inc. c) de la ley 065/2010. Igualmente, el afiliado no acede a la Prestación Solidaria de Vejez ya que según el Art. 22 de la Ley 065/2010 posee Retiros Mínimos no repuestos y aún con dicha reposición no contará con los 120 aportes requeridos en el Art. 13 inc. b) de la mencionada Ley. Finalmente, hago de su conocimiento que en cumplimiento a lo establecido en el Art. 172 a) del DS. 822 modificado por el D.S. 1888/2014, el asegurado puede acceder al Beneficio de Retiros Mínimos o Retiro Final. ', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');
INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC11', 'RECHAZO CON RETIROS EFECTUADOS CON ANTERIORIDAD Y EN CASO DE REPONER ACCEDE A SOLIDARIA', 11, 'Por medio de la presente, hago de su conocimiento que luego de procesar la Solicitud de Pensión del afiliado de referencia, fue rechazada debido a que no cumple los requisitos necesarios para acceder a una Prestación de Vejez, toda vez que el Saldo Acumulado en su Cuenta Personal Previsional, no le permite financiar un monto de Pensión mayor o igual al 60% de su referente Salarial de vejez, tal y como se establece el Art. 8 inciso b) de la Ley N°65/2010.De igual forma efectuado el análisis de su caso, no accede a la Prestación Solidaria de Vejez  ya que cuenta con retiros Mínimos en su cuenta personal previsional que no fueron repuestos, sin embargo en caso de efectuar la reposición de los mismos más los rendimientos generados si podrá acceder a dicha Prestación, según lo instruido en el Art. 22 de la ley 065/2010. Finalmente, hago de su conocimiento que en cumplimiento a lo establecido en el Art. 172 a) del DS. 822 modificado por el D.S. 1888/2014, el afiliado puede acceder al Beneficio de Retiros Mínimos o Retiro Final', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');
INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC12', 'RECHAZO PARA TRAMITES DE ASEGURADOS FALLECIDOS SIN CC', 12, 'Por medio de la presente, tenemos a bien poner a su conocimiento que luego de procesar la Solicitud de Pensión del Asegurado de referencia, la misma fue rechazada debido a que no cumple los requisitos necesarios para acceder a una Prestación de Vejez, toda vez que su Saldo Acumulado en su Cuenta Personal Previsional, no le permite financiar una Pensión base de por lo menos el 60% de un Salario Mínimo Nacional tal como lo establece el Art. 167 pÃ¡rrafo II del D.S. 0822 y la Circular APS/DPC/DJ/N°40/2013. Igualmente, el afiliado no accede a la Prestación Solidaria de Vejez por que no cuenta con los 120 aportes requeridos, según el Art. 13 inc. b) la Ley N°65/2010. Finalmente, hago de su conocimiento que en cumplimiento a lo establecido en el Art. 172 inc. a) del DS. 822, modificada por el D.S. 1888, sus derecho habientes pueden acceder al Beneficio de Retiros Mínimos o Retiro Final.', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');
INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC13', 'RECHAZO PARA TRAMITES DE ASEGURADOS FALLECIDOS CON CCM', 13, 'Por medio de la presente, tenemos a bien poner a su conocimiento que luego de procesar la Solicitud de Pensión del Asegurado de referencia, la misma fue rechazada debido a que no cumple los requisitos necesarios para acceder a una Prestación de Vejez, toda vez que su Saldo Acumulado en su Cuenta Personal Previsional más su Compensación de Cotizaciones, no le permite financiar una Pensión base de por lo menos el 60% de un Salario Mínimo Nacional tal como lo establece el Art. 167 párrafo II del D.S. 0822 y la Circular APS/DPC/DJ/N°40/2013. Igualmente, el afiliado no accede a la Prestación Solidaria de Vejez por que no cuenta con los 120 aportes requeridos en el Art. 13 inc. b) de la Ley N° 065/2010. Finalmente, hago de su conocimiento que en cumplimiento a lo establecido en el Art. 172 inc. a) del DS. 1888, sus derechohabientes pueden acceder al Beneficio de Retiros Mínimos o Retiro Final y pago de CC Mensual,  en virtud al Art. 47 Parágrafo II de la R.A.032/2011.', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');
INSERT INTO public.dominio
(dominio, codigo, nombre, orden, descripcion, subdominio, fecha_registro, fecha_modifica, usuario_registro, estado)
VALUES( 'manejo_codigo', 'RC14', 'RECHAZO PARA TRAMITES DE ASEGURADOS FALLECIDOS EN CASO DE REPONER LOS DERECHOHABIENTES ACCEDEN A PSV', 14, 'Por medio de la presente, tenemos a bien poner a su conocimiento que luego de procesar la Solicitud de Pensión del Asegurado de referencia, la misma fue rechazada debido a que no cumple los requisitos necesarios para acceder a una Prestación de Vejez, toda vez que su Saldo Acumulado en su Cuenta Personal Previsional , no le permite financiar una Pensión base de por lo menos el 60% de un Salario Mínimo Nacional tal como lo establece el Art. 167 pÃ¡rrafo II del D.S. 0822 y la Circular APS/DPC/DJ/N°40/2013. Asimismo, informamos que los derechohabientes pueden acceder a una Prestación Solidaria de Vejez siempre y cuando hagan la devolución total del monto retirado vÃ­a Retiros Mínimos más los rendimientos que hasta la fecha de reposición se hubieran generado por los periodos retirados, según el Art. 22 ley Nro. 065. Finalmente, hago de su conocimiento que en cumplimiento a lo establecido en el Art. 172 inc. a) del DS. 822, modificada por el D.S. 1888, sus derecho habientes pueden acceder al Beneficio de Retiros Mínimos o Retiro Final.', NULL, '2024-10-23 09:15:24.340', '2024-10-23 09:15:24.340', NULL, 'A');


---- DROP FUNCTION public.sp_act_cas_pcc_rech_jub_validar(text, text);

CREATE OR REPLACE FUNCTION public.sp_act_cas_pcc_rech_jub_validar(v_cas_id_jub text, v_cas_id_pcc text)
 RETURNS TABLE(r_htc_id integer, r_codigo text, r_val_codigo text, r_monto_rechado text, r_act_orden text, r_estado_deribacion text, r_descripcion_derivacion text, r_dias integer, r_descripcion text,r_cua text)
 LANGUAGE plpgsql
AS $function$
    DECLARE 
		
			id_caso_real integer;
			data_jub jsonb;
            o_htc_id integer;
            o_tipo_rechazo text;
            o_monto_rechazo text;
            o_act_orden text;
            o_estado_deribacion text;
            o_descripcion_derivacion text;
            o_descripcion_rechazo text;
            o_cua text;
            v_codigo text;
            v_monto_rechado text;
            fecha_termino timestamp;
            val_codigo text;
            dias  integer; 
            v_dias integer;
    begin
    
	     	id_caso_real := (select case when cas_padre_id = 0 then cas_id else cas_padre_id end as caso_id	  
            from rmx_vys_casos where cas_cod_id = v_cas_id_jub);
	       	RAISE NOTICE 'Valor de es mayor a trenta id_caso_real : %', id_caso_real;
	       
				SELECT htc_id,  (
                            SELECT datos.valor->>'frm_value'
                            FROM (
                                SELECT jsonb_array_elements(c.htc_cas_data_valores) AS valor
                            ) datos
                            WHERE datos.valor->>'frm_campo' = 'MOTIVO_RECHAZO_JUB'
                        ) AS tipo_rechazo,
                         (
                            SELECT datos.valor->>'frm_value'
                            FROM (
                                SELECT jsonb_array_elements(c.htc_cas_data_valores) AS valor
                            ) datos
                            WHERE datos.valor->>'frm_campo' = 'MONTO_CC'
                        ) AS monto_rechazo, act_data->>'act_orden',htc_cas_data->>'ESTADO_DERIVACION', htc_cas_data->>'DESCRIPCION_DERIVACION',htc_cas_registrado, htc_cas_data->>'AS_CUA'
                    into o_htc_id, o_tipo_rechazo,o_monto_rechazo, o_act_orden, o_estado_deribacion, o_descripcion_derivacion,fecha_termino, o_cua
                    from rmx_vys_historico_casos c
                    inner join rmx_vys_actividades on act_id = htc_cas_act_id
                    inner join rmx_vys_nodos on nodo_id = htc_cas_nodo_id
                    inner join users on id = htc_cas_usr_id
                    where htc_cas_id = id_caso_real
                   	and  act_data->>'act_orden' = '200' and htc_cas_data->>'ESTADO_DERIVACION' = 'CON NOTA DE RECHAZO'
                    order by htc_id asc;
                       dias := (select DATE_PART('day', now() - fecha_termino) );
                   
                    IF o_htc_id > 0  then
                        RAISE NOTICE 'tienes id : %', o_htc_id;
                        v_codigo := o_tipo_rechazo;
                        v_monto_rechado :=o_monto_rechazo    ;
                        val_codigo :='VALIDO';
                    	o_descripcion_rechazo := ( select nombre  from dominio   where dominio = 'manejo_codigo' and codigo = o_tipo_rechazo);
					ELSE
                        RAISE NOTICE 'no tienes : %', o_htc_id; 
                        dias = 0;
                        v_codigo := 'RC0';
                        v_monto_rechado:='0';
                        val_codigo :='NO VALIDO';
					SELECT htc_id,  act_data->>'act_orden',htc_cas_data->>'ESTADO_DERIVACION', htc_cas_data->>'DESCRIPCION_DERIVACION', htc_cas_data->>'AS_CUA'
					into o_htc_id, o_act_orden, o_estado_deribacion, o_descripcion_derivacion,o_cua
                    from rmx_vys_historico_casos c
                    inner join rmx_vys_actividades on act_id = htc_cas_act_id
                    inner join rmx_vys_nodos on nodo_id = htc_cas_nodo_id
                    inner join users on id = htc_cas_usr_id
                    where htc_cas_id = id_caso_real
                    order by htc_id desc;
					END IF;     
				  ----------------------------------------------------------------------------------------------------------------------
          RETURN QUERY SELECT o_htc_id, v_codigo,val_codigo::text, v_monto_rechado, o_act_orden, o_estado_deribacion, o_descripcion_derivacion,dias,	o_descripcion_rechazo,o_cua;           
                            
                           
    END;
$function$
;

CREATE OR REPLACE FUNCTION public.sp_act_cas_pcc_rech_pm(v_cas_id_jub text, v_cas_id_pcc text, descripcion_rechazo text)
 RETURNS TABLE(r_dias integer, r_codigo text)
 LANGUAGE plpgsql
AS $function$
    DECLARE 
			hitorico integer;
			id_caso_real integer;
			id_caso_real2 integer;
			id_nodo integer;
			data_jub jsonb;
			fecha_inicio timestamp;
			fecha_termino timestamp;
			dias  integer; 
			fecha_tramite text;
			fecha_notificacion_rechazo text;
			data_DT_FECHA_NAC jsonb;
			v_fila_grilla RECORD;
			v_grilla_campo RECORD;
			v_sin_p text;
			v_dato text;
			v_htc_id integer;
	 		json_query TEXT;
	 	 	resultado JSONB;
	 	 	v_codigo text;
			v_dias integer;
			v_contador integer; 
			v2_htc_id integer; 
			o_tipo_rechazo text;
			o_monto_rechazo text;
    begin
	    
	   
	     	id_caso_real := (select case when cas_padre_id = 0 then cas_id else cas_padre_id end as caso_id
	  
            from rmx_vys_casos where cas_cod_id = v_cas_id_jub  limit 1 );

 				id_caso_real2 := (select case when cas_padre_id = 0 then cas_id else cas_padre_id end as caso_id
	  
            from rmx_vys_casos where cas_cod_id = v_cas_id_pcc  limit 1);

	       	RAISE NOTICE 'Valor de es mayor a trenta id_caso_real : %', id_caso_real;
	      
				SELECT htc_id, htc_cas_data_valores, htc_cas_registrado, (
                            SELECT datos.valor->>'frm_value'
                            FROM (
                                SELECT jsonb_array_elements(htc_cas_data_valores) AS valor
                            ) datos
                            WHERE datos.valor->>'frm_campo' = 'MOTIVO_RECHAZO_JUB'
                        ) AS tipo_rechazo,
                         (
                            SELECT datos.valor->>'frm_value'
                            FROM (
                                SELECT jsonb_array_elements(htc_cas_data_valores) AS valor
                            ) datos
                            WHERE datos.valor->>'frm_campo' = 'MONTO_CC'
                        ) AS monto_rechazo into v_htc_id, data_jub, fecha_termino, o_tipo_rechazo,o_monto_rechazo ---act_data, act_data->>'act_descripcion', act_data->>'act_orden' htc_cas_registrado ,htc_cas_data->>'ESTADO_DERIVACION',*
                    from rmx_vys_historico_casos
                    inner join rmx_vys_actividades on act_id = htc_cas_act_id
                    inner join rmx_vys_nodos on nodo_id = htc_cas_nodo_id
                    inner join users on id = htc_cas_usr_id
                    where htc_cas_id = id_caso_real
                    order by htc_id desc limit 1;
                   
                    dias := (select DATE_PART('day', now() - fecha_termino) );
                   fecha_notificacion_rechazo := to_char(fecha_termino::date , 'YYYY-MM-DD')::text;
					   
					fecha_tramite := to_char(now(), 'YYYY-MM-DD')::text; 


                  	RAISE NOTICE 'Valor de dias: %', dias;   
                    RAISE NOTICE 'data_jub de dias:====>> %', data_jub;   
                    
                    ----------------------------------------------------------------------------------------------------------------------
                    IF v_htc_id > 0  then
							RAISE NOTICE 'tienes id : %', v_htc_id;
							v_codigo := 'R1';
						                
					        		UPDATE rmx_vys_casos SET
									cas_data_valores = data_jub		
									where    cas_cod_id = v_cas_id_pcc;
								
									--===========================================================================================                        
					                             FOR v_fila_grilla IN  
									                    select  jsonb_path_query(a.jsonb::JSONB, '$[*] ? (@[*].col_campo == "ES_DH_FALLECIDO" )') 
														from 	(select   (
									                            SELECT datos.valor->>'frm_value'
									                            FROM (
									                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
									                            ) datos
									                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
									                        			)JSONB  
									                            from public.rmx_vys_casos c
									                            WHERE cas_cod_id = v_cas_id_pcc
									                            order by 1 desc limit 1 ) a 	
												loop
					                                raise notice 'jsonb_path_query -------------=> %',v_fila_grilla.jsonb_path_query;	
					                            ----------------------------------------------------------------------------------				
													WITH json_array AS (
													
													
													          select a.cas_id,jsonb_array_elements(a.jsonb::JSONB) AS persons  
													           from     (      select  cas_id, (
													                            SELECT datos.valor->>'frm_value'
													                            FROM (
													                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
													                            ) datos
													                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
													                        )JSONB  
													                            from public.rmx_vys_casos c
													                            WHERE cas_cod_id = v_cas_id_pcc
													                            order by 1 desc limit 1) a 
													),
													filtered_elements AS (
													    SELECT  cas_id, persons,
													           jsonb_agg(elems) FILTER (WHERE NOT (elems @> v_fila_grilla.jsonb_path_query)) AS filtered_person
													    FROM json_array,
													         jsonb_array_elements(persons) AS elems
													    GROUP BY cas_id,persons
													)
													SELECT   jsonb_agg(filtered_person) AS new_json_data into data_DT_FECHA_NAC
													FROM filtered_elements;		
													RAISE NOTICE 'Valor de data_DT_FECHA_NAC: %', data_DT_FECHA_NAC;    
												-------------------------------------------------------------------------------------------------------------------------------
										                             WITH updated_json AS (
																	  SELECT cas_id as id ,
																	         jsonb_agg(
																	           CASE
																	             WHEN elem->>'frm_campo' = 'GRILLA_DERECHOHABIENTES' THEN
																	               jsonb_set(elem, '{frm_value}', data_DT_FECHA_NAC)
																	             ELSE
																	               elem
																	           END
																	         ) AS updated_data
																	  FROM public.rmx_vys_casos c,
																	       jsonb_array_elements(cas_data_valores) AS elem
																	          WHERE --(c.cas_estado = 'T' or c.cas_estado = 'E')       and
																	                       cas_cod_id = v_cas_id_pcc
																	  GROUP BY cas_id
																	)
																	UPDATE public.rmx_vys_casos
																	SET cas_data_valores = updated_json.updated_data
																	FROM updated_json
																	WHERE cas_id = updated_json.id;
					-------------------------------------------------------------------------------------------------------------------------------	
																
					                             END LOOP;
					                            
					                            
					                            	--===========================================================================================                        
					                             FOR v_fila_grilla IN  
									                    select  jsonb_path_query(a.jsonb::JSONB, '$[*] ? (@[*].col_campo == "DH_FECHA_FALLECIDO" )') 
														from 	(select   (
									                            SELECT datos.valor->>'frm_value'
									                            FROM (
									                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
									                            ) datos
									                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
									                        			)JSONB  
									                            from public.rmx_vys_casos c
									                            WHERE cas_cod_id = v_cas_id_pcc
									                            order by 1 desc limit 1 ) a 	
												loop
					                                raise notice 'jsonb_path_query -------------=> %',v_fila_grilla.jsonb_path_query;	
					                            ----------------------------------------------------------------------------------				
													WITH json_array AS (
													          select a.cas_id,jsonb_array_elements(a.jsonb::JSONB) AS persons  
													           from     (      select  cas_id, (
													                            SELECT datos.valor->>'frm_value'
													                            FROM (
													                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
													                            ) datos
													                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
													                        )JSONB  
													                            from public.rmx_vys_casos c
													                            WHERE cas_cod_id = v_cas_id_pcc
													                            order by 1 desc limit 1) a 
													),
													filtered_elements AS (
													    SELECT  cas_id, persons,
													           jsonb_agg(elems) FILTER (WHERE NOT (elems @> v_fila_grilla.jsonb_path_query)) AS filtered_person
													    FROM json_array,
													         jsonb_array_elements(persons) AS elems
													    GROUP BY cas_id,persons
													)
													SELECT   jsonb_agg(filtered_person) AS new_json_data into data_DT_FECHA_NAC
													FROM filtered_elements;		
													RAISE NOTICE 'Valor de data_DT_FECHA_NAC: %', data_DT_FECHA_NAC;    
												-------------------------------------------------------------------------------------------------------------------------------
										                             WITH updated_json AS (
																	  SELECT cas_id as id ,
																	         jsonb_agg(
																	           CASE
																	             WHEN elem->>'frm_campo' = 'GRILLA_DERECHOHABIENTES' THEN
																	               jsonb_set(elem, '{frm_value}', data_DT_FECHA_NAC)
																	             ELSE
																	               elem
																	           END
																	         ) AS updated_data
																	  FROM public.rmx_vys_casos c,
																	       jsonb_array_elements(cas_data_valores) AS elem
																	          WHERE --(c.cas_estado = 'T' or c.cas_estado = 'E')       and
																	                       cas_cod_id = v_cas_id_pcc
																	  GROUP BY cas_id
																	)
																	UPDATE public.rmx_vys_casos
																	SET cas_data_valores = updated_json.updated_data
																	FROM updated_json
																	WHERE cas_id = updated_json.id;
					-------------------------------------------------------------------------------------------------------------------------------	
																
					                             END LOOP;
					                            	--===========================================================================================                        
					                             FOR v_fila_grilla IN  
									                    select  jsonb_path_query(a.jsonb::JSONB, '$[*] ? (@[*].col_campo == "DH_MATRIMONIO" )') 
														from 	(select   (
									                            SELECT datos.valor->>'frm_value'
									                            FROM (
									                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
									                            ) datos
									                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
									                        			)JSONB  
									                            from public.rmx_vys_casos c
									                            WHERE cas_cod_id = v_cas_id_pcc
									                            order by 1 desc limit 1 ) a 	
												loop
					                                raise notice 'jsonb_path_query -------------=> %',v_fila_grilla.jsonb_path_query;	
					                            ----------------------------------------------------------------------------------				
													WITH json_array AS (
													          select a.cas_id,jsonb_array_elements(a.jsonb::JSONB) AS persons  
													           from     (      select  cas_id, (
													                            SELECT datos.valor->>'frm_value'
													                            FROM (
													                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
													                            ) datos
													                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
													                        )JSONB  
													                            from public.rmx_vys_casos c
													                            WHERE cas_cod_id = v_cas_id_pcc
													                            order by 1 desc limit 1) a 
													),
													filtered_elements AS (
													    SELECT  cas_id, persons,
													           jsonb_agg(elems) FILTER (WHERE NOT (elems @> v_fila_grilla.jsonb_path_query)) AS filtered_person
													    FROM json_array,
													         jsonb_array_elements(persons) AS elems
													    GROUP BY cas_id,persons
													)
													SELECT   jsonb_agg(filtered_person) AS new_json_data into data_DT_FECHA_NAC
													FROM filtered_elements;		
													RAISE NOTICE 'Valor de data_DT_FECHA_NAC: %', data_DT_FECHA_NAC;    
												-------------------------------------------------------------------------------------------------------------------------------
										                             WITH updated_json AS (
																	  SELECT cas_id as id ,
																	         jsonb_agg(
																	           CASE
																	             WHEN elem->>'frm_campo' = 'GRILLA_DERECHOHABIENTES' THEN
																	               jsonb_set(elem, '{frm_value}', data_DT_FECHA_NAC)
																	             ELSE
																	               elem
																	           END
																	         ) AS updated_data
																	  FROM public.rmx_vys_casos c,
																	       jsonb_array_elements(cas_data_valores) AS elem
																	          WHERE --(c.cas_estado = 'T' or c.cas_estado = 'E')       and
																	                       cas_cod_id = v_cas_id_pcc
																	  GROUP BY cas_id
																	)
																	UPDATE public.rmx_vys_casos
																	SET cas_data_valores = updated_json.updated_data
																	FROM updated_json
																	WHERE cas_id = updated_json.id;
					-------------------------------------------------------------------------------------------------------------------------------	
																
					                             END LOOP;
					                            	--===========================================================================================                        
					                             FOR v_fila_grilla IN  
									                    select  jsonb_path_query(a.jsonb::JSONB, '$[*] ? (@[*].col_campo == "DH_FECHA_EMISION_MATRIMONIO" )') 
														from 	(select   (
									                            SELECT datos.valor->>'frm_value'
									                            FROM (
									                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
									                            ) datos
									                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
									                        			)JSONB  
									                            from public.rmx_vys_casos c
									                            WHERE cas_cod_id = v_cas_id_pcc
									                            order by 1 desc limit 1 ) a 	
												loop
					                                raise notice 'jsonb_path_query -------------=> %',v_fila_grilla.jsonb_path_query;	
					                            ----------------------------------------------------------------------------------				
													WITH json_array AS (
													          select a.cas_id,jsonb_array_elements(a.jsonb::JSONB) AS persons  
													           from     (      select  cas_id, (
													                            SELECT datos.valor->>'frm_value'
													                            FROM (
													                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
													                            ) datos
													                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
													                        )JSONB  
													                            from public.rmx_vys_casos c
													                            WHERE cas_cod_id = v_cas_id_pcc
													                            order by 1 desc limit 1) a 
													),
													filtered_elements AS (
													    SELECT  cas_id, persons,
													           jsonb_agg(elems) FILTER (WHERE NOT (elems @> v_fila_grilla.jsonb_path_query)) AS filtered_person
													    FROM json_array,
													         jsonb_array_elements(persons) AS elems
													    GROUP BY cas_id,persons
													)
													SELECT   jsonb_agg(filtered_person) AS new_json_data into data_DT_FECHA_NAC
													FROM filtered_elements;		
													RAISE NOTICE 'Valor de data_DT_FECHA_NAC: %', data_DT_FECHA_NAC;    
												-------------------------------------------------------------------------------------------------------------------------------
										                             WITH updated_json AS (
																	  SELECT cas_id as id ,
																	         jsonb_agg(
																	           CASE
																	             WHEN elem->>'frm_campo' = 'GRILLA_DERECHOHABIENTES' THEN
																	               jsonb_set(elem, '{frm_value}', data_DT_FECHA_NAC)
																	             ELSE
																	               elem
																	           END
																	         ) AS updated_data
																	  FROM public.rmx_vys_casos c,
																	       jsonb_array_elements(cas_data_valores) AS elem
																	          WHERE --(c.cas_estado = 'T' or c.cas_estado = 'E')       and
																	                       cas_cod_id = v_cas_id_pcc
																	  GROUP BY cas_id
																	)
																	UPDATE public.rmx_vys_casos
																	SET cas_data_valores = updated_json.updated_data
																	FROM updated_json
																	WHERE cas_id = updated_json.id;
					-------------------------------------------------------------------------------------------------------------------------------	
					                             END LOOP;
					                  -----------------------------------------------------------------------------------------
					                                           WITH updated_json AS (
								  SELECT cas_id as id ,
								         jsonb_agg(
								           CASE
								             WHEN elem->>'frm_campo' = 'AS_TIPO_EAP' THEN
								               jsonb_set(elem, '{frm_value}', '"CVEAP-B5"')
								             ELSE
								               elem
								           END
								         ) AS updated_data
								  FROM public.rmx_vys_casos c,
								       jsonb_array_elements(cas_data_valores) AS elem
								          WHERE --(c.cas_estado = 'T' or c.cas_estado = 'E')       and
								                       cas_cod_id = v_cas_id_pcc
								  GROUP BY cas_id
								)
								-- Aplicamos la actualización a la tabla original
								UPDATE public.rmx_vys_casos
								SET cas_data_valores = updated_json.updated_data
								FROM updated_json
								WHERE cas_id = updated_json.id;
								
								
								                     
								                         WITH updated_json AS (
								  SELECT cas_id as id ,
								         jsonb_agg(
								           CASE
								             WHEN elem->>'frm_campo' = 'AS_TIPO_EAP' THEN
								               jsonb_set(elem, '{frm_value_label}', '"5. SOLICITUD DE PAGO DE CCM (POSTERIOR AL RECHAZO DE PENSIÓN POR MUERTE)"')
								             ELSE
								               elem
								           END
								         ) AS updated_data
								  FROM public.rmx_vys_casos c,
								       jsonb_array_elements(cas_data_valores) AS elem
								          WHERE --(c.cas_estado = 'T' or c.cas_estado = 'E')       and
								                       cas_cod_id=v_cas_id_pcc
								  GROUP BY cas_id
								)
								-- Aplicamos la actualización a la tabla original
								UPDATE public.rmx_vys_casos
								SET cas_data_valores = updated_json.updated_data
								FROM updated_json
								WHERE cas_id = updated_json.id;
								
								
								UPDATE public.rmx_vys_casos
								SET cas_data_valores = jsonb_set(
								    cas_data_valores,
								    '{999}',  -- la posición en el array
								    (
								        SELECT jsonb_build_object(
								            'frm_tipo', 'TEXT',
								            'frm_campo', 'CASO_RECHAZADO',
								            'frm_value', v_cas_id_jub,
								            'frm_deshabilitado', 'false',
								            'frm_deshabilitadoo', false
								        )
								    ))
								WHERE   cas_cod_id=v_cas_id_pcc;
								
								UPDATE public.rmx_vys_casos
								SET cas_data_valores = jsonb_set(
								    cas_data_valores,
								    '{999}',  -- la posición en el array
								    (
								        SELECT jsonb_build_object(
								            'frm_tipo', 'DATE',
								            'frm_campo', 'FECHA_INICIO_TRAMITE',
								            'frm_value', fecha_tramite,
								            'frm_deshabilitado', 'true',
								            'frm_deshabilitadoo', true
								        )
								    ))
								WHERE   cas_cod_id=v_cas_id_pcc;
								
								UPDATE public.rmx_vys_casos
								SET cas_data_valores = jsonb_set(
								    cas_data_valores,
								    '{999}', 
								    (
								        SELECT jsonb_build_object(
								            'frm_tipo', 'DATE',
								            'frm_campo', 'FECHA_NOTIFICACION_RECHAZO',
								            'frm_value', fecha_notificacion_rechazo,
								            'frm_deshabilitado', 'true',
								            'frm_deshabilitadoo', true
								        )
								    ))
								WHERE   cas_cod_id=v_cas_id_pcc;
							
									UPDATE public.rmx_vys_casos
								SET cas_data_valores = jsonb_set(
								    cas_data_valores,
								    '{999}', 
								    (
								        SELECT jsonb_build_object(
								            'frm_tipo', 'TEXT',
								            'frm_campo', 'MOTIVO_RECHAZO',
								            'frm_value', descripcion_rechazo,
								            'frm_deshabilitado', 'true',
								            'frm_deshabilitadoo', true
								        )
								    ))
								WHERE   cas_cod_id=v_cas_id_pcc;
							
									UPDATE public.rmx_vys_casos
								SET cas_data_valores = jsonb_set(
								    cas_data_valores,
								    '{999}', 
								    (
								        SELECT jsonb_build_object(
								            'frm_tipo', 'TEXT',
								            'frm_campo', 'MONTO_RECHAZO',
								            'frm_value', o_monto_rechazo,
								            'frm_deshabilitado', 'true',
								            'frm_deshabilitadoo', true
								        )
								    ))
								WHERE   cas_cod_id=v_cas_id_pcc;
							
			-------------------------------------------------------------------------------------------
							select count(*) into v_contador  from   public._gp_documentos where doc_codigo = v_cas_id_pcc  and doc_categoria != '';
							
							   IF v_contador  > 0  then 
							   
							   UPDATE public._gp_documentos
                                                            SET 
                                                            doc_referencia = '',
                                                            doc_categoria = ''
                                                            WHERE   doc_codigo= v_cas_id_pcc;
							   
							   	else
							   	
							  v2_htc_id := (	select htc_id
                                                            from rmx_vys_historico_casos
                                                            where  htc_cas_cod_id = v_cas_id_pcc order by htc_id asc limit 1);
					    
					     INSERT INTO public._gp_documentos ( doc_cas_id, doc_usr_id, doc_his_id, doc_codigo, doc_referencia, doc_categoria, doc_url, doc_doc_id, doc_registrado, doc_modificado, doc_usuario, doc_estado, doc_descripcion, doc_estado_preparacion, doc_documento_original_obligatorio, doc_presentacion_obligatoria, doc_copia_original, doc_id_persona_sip, doc_id_observacion, doc_detalle_documento, alerta, doc_prestacion)
                    select  id_caso_real2, doc_usr_id,v2_htc_id, v_cas_id_pcc , doc_referencia, doc_categoria, doc_url, doc_doc_id, doc_registrado, doc_modificado, doc_usuario, doc_estado, doc_descripcion, doc_estado_preparacion, doc_documento_original_obligatorio, doc_presentacion_obligatoria, doc_copia_original, doc_id_persona_sip, doc_id_observacion, doc_detalle_documento, alerta, doc_prestacion
                    FROM public._gp_documentos
                    WHERE doc_codigo = v_cas_id_jub and doc_descripcion != 'FORMULARIO DE RECEPCIÓN DE DOCUMENTOS' ; 
								END IF; 
							
							
							
							
							
							
			-------------------------------------------------------------------------------------------

					                          
					
					ELSE
					     RAISE NOTICE 'no tienes : %', v_htc_id;
					      v_codigo := 'R2';
					     
					     UPDATE rmx_vys_casos SET
									cas_data_valores = '[]'::jsonb		
									where    cas_cod_id = v_cas_id_pcc;
					   
					END IF;                                                      
				
				  ----------------------------------------------------------------------------------------------------------------------
  
          RETURN QUERY SELECT dias::integer, v_codigo::text;           
                            
                           
    END;
$function$
;

CREATE OR REPLACE FUNCTION public.sp_act_cas_pcc_rech_pencion_muerto_validar(v_cas_id_jub text, v_cas_id_pcc text)
 RETURNS TABLE(r_htc_id integer, r_codigo text, r_val_codigo text, r_monto_rechado text, r_act_orden text, r_estado_deribacion text, r_descripcion_derivacion text, r_dias integer, r_descripcion text, r_cua text,r_fecha_fallecimiento text)
 LANGUAGE plpgsql
AS $function$
    DECLARE 
		
			id_caso_real integer;
			data_jub jsonb;
            o_htc_id integer;
            o_tipo_rechazo text;
            o_monto_rechazo text;
            o_act_orden text;
            o_estado_deribacion text;
            o_descripcion_derivacion text;
            o_descripcion_rechazo text;
            o_cua text;
            v_codigo text;
            v_monto_rechado text;
            fecha_termino timestamp;
            val_codigo text;
            dias  integer; 
            v_dias integer;
            o_fecha_fallecimiento text;
    begin
    
	     	id_caso_real := (select case when cas_padre_id = 0 then cas_id else cas_padre_id end as caso_id	  
            from rmx_vys_casos where cas_cod_id = v_cas_id_jub limit 1);
	       	RAISE NOTICE 'Valor de es mayor a trenta id_caso_real : %', id_caso_real;
	       
				SELECT htc_id,  (
                            SELECT datos.valor->>'frm_value'
                            FROM (
                                SELECT jsonb_array_elements(c.htc_cas_data_valores) AS valor
                            ) datos
                            WHERE datos.valor->>'frm_campo' = 'MOTIVO_RECHAZO_JUB'
                        ) AS tipo_rechazo,
                         (
                            SELECT datos.valor->>'frm_value'
                            FROM (
                                SELECT jsonb_array_elements(c.htc_cas_data_valores) AS valor
                            ) datos
                            WHERE datos.valor->>'frm_campo' = 'MONTO_CC'
                        ) AS monto_rechazo, act_data->>'act_orden',htc_cas_data->>'ESTADO_DERIVACION', htc_cas_data->>'DESCRIPCION_DERIVACION',htc_cas_registrado, htc_cas_data->>'AS_CUA', (
                            SELECT datos.valor->>'frm_value'
                            FROM (
                                SELECT jsonb_array_elements(c.htc_cas_data_valores) AS valor
                            ) datos
                            WHERE datos.valor->>'frm_campo' = 'AS_NACIMIENTO'
                        ) AS fecha_fallecimiento 
                    into o_htc_id, o_tipo_rechazo,o_monto_rechazo, o_act_orden, o_estado_deribacion, o_descripcion_derivacion,fecha_termino, o_cua, o_fecha_fallecimiento
                    from rmx_vys_historico_casos c
                    inner join rmx_vys_actividades on act_id = htc_cas_act_id
                    inner join rmx_vys_nodos on nodo_id = htc_cas_nodo_id
                    inner join users on id = htc_cas_usr_id
                    where htc_cas_id = id_caso_real
                    order by htc_id desc;
                       dias := (select DATE_PART('day', now() - fecha_termino) );
                   
                    IF o_htc_id > 0  then
                        RAISE NOTICE 'tienes id : %', o_htc_id;
                        v_codigo := o_tipo_rechazo;
                        v_monto_rechado :=o_monto_rechazo    ;
                        val_codigo :='VALIDO';
                    	o_descripcion_rechazo := ( select nombre  from dominio   where dominio = 'manejo_codigo' and codigo = o_tipo_rechazo);
					ELSE
                        RAISE NOTICE 'no tienes : %', o_htc_id; 
                        dias = 0;
                        v_codigo := 'RC0';
                        v_monto_rechado:='0';
                        val_codigo :='NO VALIDO';
					SELECT htc_id,  act_data->>'act_orden',htc_cas_data->>'ESTADO_DERIVACION', htc_cas_data->>'DESCRIPCION_DERIVACION', htc_cas_data->>'AS_CUA'
					into o_htc_id, o_act_orden, o_estado_deribacion, o_descripcion_derivacion,o_cua
                    from rmx_vys_historico_casos c
                    inner join rmx_vys_actividades on act_id = htc_cas_act_id
                    inner join rmx_vys_nodos on nodo_id = htc_cas_nodo_id
                    inner join users on id = htc_cas_usr_id
                    where htc_cas_id = id_caso_real
                    order by htc_id desc;
					END IF;     
				  ----------------------------------------------------------------------------------------------------------------------
          RETURN QUERY SELECT o_htc_id, v_codigo,val_codigo::text, v_monto_rechado, o_act_orden, o_estado_deribacion, o_descripcion_derivacion,dias,	o_descripcion_rechazo,o_cua, o_fecha_fallecimiento;           
                            
                           
    END;
$function$
;






-- DROP FUNCTION public.sp_act_cas_pcc_rech_jub(text, text);

CREATE OR REPLACE FUNCTION public.sp_act_cas_pcc_rech_jub(v_cas_id_jub text, v_cas_id_pcc text, descripcion_rechazo text)
 RETURNS TABLE(r_dias integer, r_codigo text)
 LANGUAGE plpgsql
AS $function$
    DECLARE 
			hitorico integer;
			id_caso_real integer;
			id_caso_real2 integer;
			id_nodo integer;
			data_jub jsonb;
			fecha_inicio timestamp;
			fecha_termino timestamp;
			dias  integer; 
			fecha_tramite text;
			fecha_notificacion_rechazo text;
			data_DT_FECHA_NAC jsonb;
			v_fila_grilla RECORD;
			v_grilla_campo RECORD;
			v_sin_p text;
			v_dato text;
			v_htc_id integer;
	 		json_query TEXT;
	 	 	resultado JSONB;
	 	 	v_codigo text;
			v_dias integer;
			v_contador integer; 
			v2_htc_id integer; 
			o_tipo_rechazo text;
			o_monto_rechazo text;
    begin
	    
	   
	     	id_caso_real := (select case when cas_padre_id = 0 then cas_id else cas_padre_id end as caso_id
	  
            from rmx_vys_casos where cas_cod_id = v_cas_id_jub);

 				id_caso_real2 := (select case when cas_padre_id = 0 then cas_id else cas_padre_id end as caso_id
	  
            from rmx_vys_casos where cas_cod_id = v_cas_id_pcc);

	       	RAISE NOTICE 'Valor de es mayor a trenta id_caso_real : %', id_caso_real;
	      
				SELECT htc_id, htc_cas_data_valores, htc_cas_registrado, (
                            SELECT datos.valor->>'frm_value'
                            FROM (
                                SELECT jsonb_array_elements(htc_cas_data_valores) AS valor
                            ) datos
                            WHERE datos.valor->>'frm_campo' = 'MOTIVO_RECHAZO_JUB'
                        ) AS tipo_rechazo,
                         (
                            SELECT datos.valor->>'frm_value'
                            FROM (
                                SELECT jsonb_array_elements(htc_cas_data_valores) AS valor
                            ) datos
                            WHERE datos.valor->>'frm_campo' = 'MONTO_CC'
                        ) AS monto_rechazo into v_htc_id, data_jub, fecha_termino, o_tipo_rechazo,o_monto_rechazo ---act_data, act_data->>'act_descripcion', act_data->>'act_orden' htc_cas_registrado ,htc_cas_data->>'ESTADO_DERIVACION',*
                    from rmx_vys_historico_casos
                    inner join rmx_vys_actividades on act_id = htc_cas_act_id
                    inner join rmx_vys_nodos on nodo_id = htc_cas_nodo_id
                    inner join users on id = htc_cas_usr_id
                    where htc_cas_id = id_caso_real
                   	and  act_data->>'act_orden' = '200' and htc_cas_data->>'ESTADO_DERIVACION' = 'CON NOTA DE RECHAZO'
                    order by htc_id asc;
                   
                    dias := (select DATE_PART('day', now() - fecha_termino) );
                   fecha_notificacion_rechazo := to_char(fecha_termino::date , 'YYYY-MM-DD')::text;
					   
					IF  dias> 30  THEN
							RAISE NOTICE 'Valor de es mayor a trenta dias : %', dias;
						fecha_tramite := to_char(now(), 'YYYY-MM-DD')::text; 
					ELSE
					      	RAISE NOTICE 'Valor es menor de los 30 dias : %', dias;
					      select cas_registrado into fecha_inicio from public.rmx_vys_casos rvc where rvc.cas_id = id_caso_real;
					      fecha_tramite :=  to_char(fecha_inicio::date , 'YYYY-MM-DD')::text;
					END IF;                                                      
                  	RAISE NOTICE 'Valor de dias: %', dias;   
                    RAISE NOTICE 'data_jub de dias:====>> %', data_jub;   
                    
                    ----------------------------------------------------------------------------------------------------------------------
                    IF v_htc_id > 0  then
							RAISE NOTICE 'tienes id : %', v_htc_id;
							v_codigo := 'R1';
						                
					        		UPDATE rmx_vys_casos SET
									cas_data_valores = data_jub		
									where    cas_cod_id = v_cas_id_pcc;
								
									--===========================================================================================                        
					                             FOR v_fila_grilla IN  
									                    select  jsonb_path_query(a.jsonb::JSONB, '$[*] ? (@[*].col_campo == "ES_DH_FALLECIDO" )') 
														from 	(select   (
									                            SELECT datos.valor->>'frm_value'
									                            FROM (
									                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
									                            ) datos
									                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
									                        			)JSONB  
									                            from public.rmx_vys_casos c
									                            WHERE cas_cod_id = v_cas_id_pcc
									                            order by 1 desc limit 1 ) a 	
												loop
					                                raise notice 'jsonb_path_query -------------=> %',v_fila_grilla.jsonb_path_query;	
					                            ----------------------------------------------------------------------------------				
													WITH json_array AS (
													
													
													          select a.cas_id,jsonb_array_elements(a.jsonb::JSONB) AS persons  
													           from     (      select  cas_id, (
													                            SELECT datos.valor->>'frm_value'
													                            FROM (
													                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
													                            ) datos
													                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
													                        )JSONB  
													                            from public.rmx_vys_casos c
													                            WHERE cas_cod_id = v_cas_id_pcc
													                            order by 1 desc limit 1) a 
													),
													filtered_elements AS (
													    SELECT  cas_id, persons,
													           jsonb_agg(elems) FILTER (WHERE NOT (elems @> v_fila_grilla.jsonb_path_query)) AS filtered_person
													    FROM json_array,
													         jsonb_array_elements(persons) AS elems
													    GROUP BY cas_id,persons
													)
													SELECT   jsonb_agg(filtered_person) AS new_json_data into data_DT_FECHA_NAC
													FROM filtered_elements;		
													RAISE NOTICE 'Valor de data_DT_FECHA_NAC: %', data_DT_FECHA_NAC;    
												-------------------------------------------------------------------------------------------------------------------------------
										                             WITH updated_json AS (
																	  SELECT cas_id as id ,
																	         jsonb_agg(
																	           CASE
																	             WHEN elem->>'frm_campo' = 'GRILLA_DERECHOHABIENTES' THEN
																	               jsonb_set(elem, '{frm_value}', data_DT_FECHA_NAC)
																	             ELSE
																	               elem
																	           END
																	         ) AS updated_data
																	  FROM public.rmx_vys_casos c,
																	       jsonb_array_elements(cas_data_valores) AS elem
																	          WHERE --(c.cas_estado = 'T' or c.cas_estado = 'E')       and
																	                       cas_cod_id = v_cas_id_pcc
																	  GROUP BY cas_id
																	)
																	UPDATE public.rmx_vys_casos
																	SET cas_data_valores = updated_json.updated_data
																	FROM updated_json
																	WHERE cas_id = updated_json.id;
					-------------------------------------------------------------------------------------------------------------------------------	
																
					                             END LOOP;
					                            
					                            
					                            	--===========================================================================================                        
					                             FOR v_fila_grilla IN  
									                    select  jsonb_path_query(a.jsonb::JSONB, '$[*] ? (@[*].col_campo == "DH_FECHA_FALLECIDO" )') 
														from 	(select   (
									                            SELECT datos.valor->>'frm_value'
									                            FROM (
									                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
									                            ) datos
									                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
									                        			)JSONB  
									                            from public.rmx_vys_casos c
									                            WHERE cas_cod_id = v_cas_id_pcc
									                            order by 1 desc limit 1 ) a 	
												loop
					                                raise notice 'jsonb_path_query -------------=> %',v_fila_grilla.jsonb_path_query;	
					                            ----------------------------------------------------------------------------------				
													WITH json_array AS (
													          select a.cas_id,jsonb_array_elements(a.jsonb::JSONB) AS persons  
													           from     (      select  cas_id, (
													                            SELECT datos.valor->>'frm_value'
													                            FROM (
													                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
													                            ) datos
													                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
													                        )JSONB  
													                            from public.rmx_vys_casos c
													                            WHERE cas_cod_id = v_cas_id_pcc
													                            order by 1 desc limit 1) a 
													),
													filtered_elements AS (
													    SELECT  cas_id, persons,
													           jsonb_agg(elems) FILTER (WHERE NOT (elems @> v_fila_grilla.jsonb_path_query)) AS filtered_person
													    FROM json_array,
													         jsonb_array_elements(persons) AS elems
													    GROUP BY cas_id,persons
													)
													SELECT   jsonb_agg(filtered_person) AS new_json_data into data_DT_FECHA_NAC
													FROM filtered_elements;		
													RAISE NOTICE 'Valor de data_DT_FECHA_NAC: %', data_DT_FECHA_NAC;    
												-------------------------------------------------------------------------------------------------------------------------------
										                             WITH updated_json AS (
																	  SELECT cas_id as id ,
																	         jsonb_agg(
																	           CASE
																	             WHEN elem->>'frm_campo' = 'GRILLA_DERECHOHABIENTES' THEN
																	               jsonb_set(elem, '{frm_value}', data_DT_FECHA_NAC)
																	             ELSE
																	               elem
																	           END
																	         ) AS updated_data
																	  FROM public.rmx_vys_casos c,
																	       jsonb_array_elements(cas_data_valores) AS elem
																	          WHERE --(c.cas_estado = 'T' or c.cas_estado = 'E')       and
																	                       cas_cod_id = v_cas_id_pcc
																	  GROUP BY cas_id
																	)
																	UPDATE public.rmx_vys_casos
																	SET cas_data_valores = updated_json.updated_data
																	FROM updated_json
																	WHERE cas_id = updated_json.id;
					-------------------------------------------------------------------------------------------------------------------------------	
																
					                             END LOOP;
					                            	--===========================================================================================                        
					                             FOR v_fila_grilla IN  
									                    select  jsonb_path_query(a.jsonb::JSONB, '$[*] ? (@[*].col_campo == "DH_MATRIMONIO" )') 
														from 	(select   (
									                            SELECT datos.valor->>'frm_value'
									                            FROM (
									                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
									                            ) datos
									                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
									                        			)JSONB  
									                            from public.rmx_vys_casos c
									                            WHERE cas_cod_id = v_cas_id_pcc
									                            order by 1 desc limit 1 ) a 	
												loop
					                                raise notice 'jsonb_path_query -------------=> %',v_fila_grilla.jsonb_path_query;	
					                            ----------------------------------------------------------------------------------				
													WITH json_array AS (
													          select a.cas_id,jsonb_array_elements(a.jsonb::JSONB) AS persons  
													           from     (      select  cas_id, (
													                            SELECT datos.valor->>'frm_value'
													                            FROM (
													                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
													                            ) datos
													                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
													                        )JSONB  
													                            from public.rmx_vys_casos c
													                            WHERE cas_cod_id = v_cas_id_pcc
													                            order by 1 desc limit 1) a 
													),
													filtered_elements AS (
													    SELECT  cas_id, persons,
													           jsonb_agg(elems) FILTER (WHERE NOT (elems @> v_fila_grilla.jsonb_path_query)) AS filtered_person
													    FROM json_array,
													         jsonb_array_elements(persons) AS elems
													    GROUP BY cas_id,persons
													)
													SELECT   jsonb_agg(filtered_person) AS new_json_data into data_DT_FECHA_NAC
													FROM filtered_elements;		
													RAISE NOTICE 'Valor de data_DT_FECHA_NAC: %', data_DT_FECHA_NAC;    
												-------------------------------------------------------------------------------------------------------------------------------
										                             WITH updated_json AS (
																	  SELECT cas_id as id ,
																	         jsonb_agg(
																	           CASE
																	             WHEN elem->>'frm_campo' = 'GRILLA_DERECHOHABIENTES' THEN
																	               jsonb_set(elem, '{frm_value}', data_DT_FECHA_NAC)
																	             ELSE
																	               elem
																	           END
																	         ) AS updated_data
																	  FROM public.rmx_vys_casos c,
																	       jsonb_array_elements(cas_data_valores) AS elem
																	          WHERE --(c.cas_estado = 'T' or c.cas_estado = 'E')       and
																	                       cas_cod_id = v_cas_id_pcc
																	  GROUP BY cas_id
																	)
																	UPDATE public.rmx_vys_casos
																	SET cas_data_valores = updated_json.updated_data
																	FROM updated_json
																	WHERE cas_id = updated_json.id;
					-------------------------------------------------------------------------------------------------------------------------------	
																
					                             END LOOP;
					                            	--===========================================================================================                        
					                             FOR v_fila_grilla IN  
									                    select  jsonb_path_query(a.jsonb::JSONB, '$[*] ? (@[*].col_campo == "DH_FECHA_EMISION_MATRIMONIO" )') 
														from 	(select   (
									                            SELECT datos.valor->>'frm_value'
									                            FROM (
									                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
									                            ) datos
									                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
									                        			)JSONB  
									                            from public.rmx_vys_casos c
									                            WHERE cas_cod_id = v_cas_id_pcc
									                            order by 1 desc limit 1 ) a 	
												loop
					                                raise notice 'jsonb_path_query -------------=> %',v_fila_grilla.jsonb_path_query;	
					                            ----------------------------------------------------------------------------------				
													WITH json_array AS (
													          select a.cas_id,jsonb_array_elements(a.jsonb::JSONB) AS persons  
													           from     (      select  cas_id, (
													                            SELECT datos.valor->>'frm_value'
													                            FROM (
													                                SELECT jsonb_array_elements(c.cas_data_valores) AS valor
													                            ) datos
													                            WHERE datos.valor->>'frm_campo' = 'GRILLA_DERECHOHABIENTES'
													                        )JSONB  
													                            from public.rmx_vys_casos c
													                            WHERE cas_cod_id = v_cas_id_pcc
													                            order by 1 desc limit 1) a 
													),
													filtered_elements AS (
													    SELECT  cas_id, persons,
													           jsonb_agg(elems) FILTER (WHERE NOT (elems @> v_fila_grilla.jsonb_path_query)) AS filtered_person
													    FROM json_array,
													         jsonb_array_elements(persons) AS elems
													    GROUP BY cas_id,persons
													)
													SELECT   jsonb_agg(filtered_person) AS new_json_data into data_DT_FECHA_NAC
													FROM filtered_elements;		
													RAISE NOTICE 'Valor de data_DT_FECHA_NAC: %', data_DT_FECHA_NAC;    
												-------------------------------------------------------------------------------------------------------------------------------
										                             WITH updated_json AS (
																	  SELECT cas_id as id ,
																	         jsonb_agg(
																	           CASE
																	             WHEN elem->>'frm_campo' = 'GRILLA_DERECHOHABIENTES' THEN
																	               jsonb_set(elem, '{frm_value}', data_DT_FECHA_NAC)
																	             ELSE
																	               elem
																	           END
																	         ) AS updated_data
																	  FROM public.rmx_vys_casos c,
																	       jsonb_array_elements(cas_data_valores) AS elem
																	          WHERE --(c.cas_estado = 'T' or c.cas_estado = 'E')       and
																	                       cas_cod_id = v_cas_id_pcc
																	  GROUP BY cas_id
																	)
																	UPDATE public.rmx_vys_casos
																	SET cas_data_valores = updated_json.updated_data
																	FROM updated_json
																	WHERE cas_id = updated_json.id;
					-------------------------------------------------------------------------------------------------------------------------------	
					                             END LOOP;
					                  -----------------------------------------------------------------------------------------
					                                           WITH updated_json AS (
								  SELECT cas_id as id ,
								         jsonb_agg(
								           CASE
								             WHEN elem->>'frm_campo' = 'AS_TIPO_EAP' THEN
								               jsonb_set(elem, '{frm_value}', '"CVEAP-B1"')
								             ELSE
								               elem
								           END
								         ) AS updated_data
								  FROM public.rmx_vys_casos c,
								       jsonb_array_elements(cas_data_valores) AS elem
								          WHERE --(c.cas_estado = 'T' or c.cas_estado = 'E')       and
								                       cas_cod_id = v_cas_id_pcc
								  GROUP BY cas_id
								)
								-- Aplicamos la actualización a la tabla original
								UPDATE public.rmx_vys_casos
								SET cas_data_valores = updated_json.updated_data
								FROM updated_json
								WHERE cas_id = updated_json.id;
								
								
								                     
								                         WITH updated_json AS (
								  SELECT cas_id as id ,
								         jsonb_agg(
								           CASE
								             WHEN elem->>'frm_campo' = 'AS_TIPO_EAP' THEN
								               jsonb_set(elem, '{frm_value_label}', '"1. SOLICITUD DE PAGO DE CCM (POSTERIOR AL RECHAZO DE JUBILACIÓN)"')
								             ELSE
								               elem
								           END
								         ) AS updated_data
								  FROM public.rmx_vys_casos c,
								       jsonb_array_elements(cas_data_valores) AS elem
								          WHERE --(c.cas_estado = 'T' or c.cas_estado = 'E')       and
								                       cas_cod_id=v_cas_id_pcc
								  GROUP BY cas_id
								)
								-- Aplicamos la actualización a la tabla original
								UPDATE public.rmx_vys_casos
								SET cas_data_valores = updated_json.updated_data
								FROM updated_json
								WHERE cas_id = updated_json.id;
								
								
								UPDATE public.rmx_vys_casos
								SET cas_data_valores = jsonb_set(
								    cas_data_valores,
								    '{999}',  -- la posición en el array
								    (
								        SELECT jsonb_build_object(
								            'frm_tipo', 'TEXT',
								            'frm_campo', 'CASO_RECHAZADO',
								            'frm_value', v_cas_id_jub,
								            'frm_deshabilitado', 'false',
								            'frm_deshabilitadoo', false
								        )
								    ))
								WHERE   cas_cod_id=v_cas_id_pcc;
								
								UPDATE public.rmx_vys_casos
								SET cas_data_valores = jsonb_set(
								    cas_data_valores,
								    '{999}',  -- la posición en el array
								    (
								        SELECT jsonb_build_object(
								            'frm_tipo', 'DATE',
								            'frm_campo', 'FECHA_INICIO_TRAMITE',
								            'frm_value', fecha_tramite,
								            'frm_deshabilitado', 'true',
								            'frm_deshabilitadoo', true
								        )
								    ))
								WHERE   cas_cod_id=v_cas_id_pcc;
								
								UPDATE public.rmx_vys_casos
								SET cas_data_valores = jsonb_set(
								    cas_data_valores,
								    '{999}', 
								    (
								        SELECT jsonb_build_object(
								            'frm_tipo', 'DATE',
								            'frm_campo', 'FECHA_NOTIFICACION_RECHAZO',
								            'frm_value', fecha_notificacion_rechazo,
								            'frm_deshabilitado', 'true',
								            'frm_deshabilitadoo', true
								        )
								    ))
								WHERE   cas_cod_id=v_cas_id_pcc;
							
									UPDATE public.rmx_vys_casos
								SET cas_data_valores = jsonb_set(
								    cas_data_valores,
								    '{999}', 
								    (
								        SELECT jsonb_build_object(
								            'frm_tipo', 'TEXT',
								            'frm_campo', 'MOTIVO_RECHAZO',
								            'frm_value', descripcion_rechazo,
								            'frm_deshabilitado', 'true',
								            'frm_deshabilitadoo', true
								        )
								    ))
								WHERE   cas_cod_id=v_cas_id_pcc;
							
									UPDATE public.rmx_vys_casos
								SET cas_data_valores = jsonb_set(
								    cas_data_valores,
								    '{999}', 
								    (
								        SELECT jsonb_build_object(
								            'frm_tipo', 'TEXT',
								            'frm_campo', 'MONTO_RECHAZO',
								            'frm_value', o_monto_rechazo,
								            'frm_deshabilitado', 'true',
								            'frm_deshabilitadoo', true
								        )
								    ))
								WHERE   cas_cod_id=v_cas_id_pcc;
							
			-------------------------------------------------------------------------------------------
							select count(*) into v_contador  from   public._gp_documentos where doc_codigo = v_cas_id_pcc  and doc_categoria != '';
							
							   IF v_contador  > 0  then 
							   
							   UPDATE public._gp_documentos
                                                            SET 
                                                            doc_referencia = '',
                                                            doc_categoria = ''
                                                            WHERE   doc_codigo= v_cas_id_pcc;
							   
							   	else
							   	
							  v2_htc_id := (	select htc_id
                                                            from rmx_vys_historico_casos
                                                            where  htc_cas_cod_id = v_cas_id_pcc order by htc_id asc limit 1);
					    
					     INSERT INTO public._gp_documentos ( doc_cas_id, doc_usr_id, doc_his_id, doc_codigo, doc_referencia, doc_categoria, doc_url, doc_doc_id, doc_registrado, doc_modificado, doc_usuario, doc_estado, doc_descripcion, doc_estado_preparacion, doc_documento_original_obligatorio, doc_presentacion_obligatoria, doc_copia_original, doc_id_persona_sip, doc_id_observacion, doc_detalle_documento, alerta, doc_prestacion)
                    select  id_caso_real2, doc_usr_id,v2_htc_id, v_cas_id_pcc , doc_referencia, doc_categoria, doc_url, doc_doc_id, doc_registrado, doc_modificado, doc_usuario, doc_estado, doc_descripcion, doc_estado_preparacion, doc_documento_original_obligatorio, doc_presentacion_obligatoria, doc_copia_original, doc_id_persona_sip, doc_id_observacion, doc_detalle_documento, alerta, doc_prestacion
                    FROM public._gp_documentos
                    WHERE doc_codigo = v_cas_id_jub and doc_descripcion != 'FORMULARIO DE RECEPCIÓN DE DOCUMENTOS' ; 
								END IF; 
							
							
							
							
							
							
			-------------------------------------------------------------------------------------------

					                          
					
					ELSE
					     RAISE NOTICE 'no tienes : %', v_htc_id;
					      v_codigo := 'R2';
					     
					     UPDATE rmx_vys_casos SET
									cas_data_valores = '[]'::jsonb		
									where    cas_cod_id = v_cas_id_pcc;
					   
					END IF;                                                      
				
				  ----------------------------------------------------------------------------------------------------------------------
  
          RETURN QUERY SELECT dias::integer, v_codigo::text;           
                            
                           
    END;
$function$
;